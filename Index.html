<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reparto Chuli - ORS + Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; width: 100%; }
    body { margin:0; font-family: sans-serif; }
    #controls { padding: 10px; }
    input, button { padding: 6px; margin: 2px; }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="getLocation()">📍 Mi Ubicación</button>
    <input type="text" id="address" placeholder="Ingresar dirección">
    <button onclick="geocodeAddress()">Agregar dirección</button>
    <button onclick="optimizeRoute()">Optimizar Ruta</button>
  </div>
  <div id="map"></div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script>
    const API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjAyNjY4YmE3NTkyMzQ5OGJiNGRkYjA2OTI0YTM3MGQ1IiwiaCI6Im11cm11cjY0In0=";

    let map = L.map('map').setView([-38.0055, -57.5426], 12); // Centro MDP
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let userMarker;
    let stops = [];

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          if (userMarker) map.removeLayer(userMarker);
          userMarker = L.marker([lat, lng], {title:"Tu ubicación"}).addTo(map).bindPopup("Estás aquí").openPopup();
          map.setView([lat, lng], 14);
          stops.unshift({lat, lng, address:"Ubicación actual"});
        }, err => alert("Error obteniendo ubicación: " + err.message));
      } else {
        alert("La geolocalización no es soportada en este navegador.");
      }
    }

    async function geocodeAddress() {
      const addr = document.getElementById('address').value.trim();
      if (!addr) return;
      try {
        const url = `https://api.openrouteservice.org/geocode/search?api_key=${API_KEY}&text=${encodeURIComponent(addr)}&boundary.country=AR`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.features && data.features.length > 0) {
          const coords = data.features[0].geometry.coordinates;
          const lng = coords[0], lat = coords[1];
          const marker = L.marker([lat, lng], {title: addr}).addTo(map).bindPopup(addr);
          stops.push({lat, lng, address: addr});
          map.setView([lat, lng], 14);
        } else {
          alert("Dirección no encontrada");
        }
      } catch(e) {
        alert("Error en geocodificación: " + e);
      }
    }

    async function optimizeRoute() {
      if (stops.length < 2) {
        alert("Agrega al menos 2 destinos");
        return;
      }
      const coords = stops.map(s => [s.lng, s.lat]);
      const body = {
        jobs: stops.slice(1).map((s,i) => ({
          id: i+1,
          location: [s.lng, s.lat]
        })),
        vehicles: [{
          id: 1,
          profile: "driving-car",
          start: [stops[0].lng, stops[0].lat]
        }]
      };

      try {
        const res = await fetch("https://api.openrouteservice.org/optimization", {
          method: "POST",
          headers: { "Authorization": API_KEY, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0].steps.flatMap(step => step.geometry);
          const line = L.polyline(route.map(c => [c[1], c[0]]), {color:"blue"}).addTo(map);
          map.fitBounds(line.getBounds());
        } else {
          alert("No se pudo optimizar la ruta");
        }
      } catch(e) {
        alert("Error en optimización: " + e);
      }
    }
  </script></body>
</html>
